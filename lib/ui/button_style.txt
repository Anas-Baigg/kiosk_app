import 'package:flutter/material.dart';
import 'package:kiosk_app/views/products_management_page.dart';
import 'package:kiosk_app/views/report.dart';
import 'package:kiosk_app/views/transactions.dart';
import 'package:kiosk_app/ui/gradient_scaffold.dart';
import 'clocks_dialogs.dart';
import 'employee_management_page.dart';
import 'cuts_management_page.dart';
import 'package:kiosk_app/services/sync_service.dart';

class HomePage extends StatefulWidget {
  const HomePage({super.key});

  @override
  State<HomePage> createState() => _HomePageState();
}

class _HomePageState extends State<HomePage> {
  bool _isSyncing = false;

  static const _labelStyle = TextStyle(
    fontSize: 18,
    fontWeight: FontWeight.bold,
    fontStyle: FontStyle.normal,
    fontFamily: "RobotoMono",
    color: Color.fromARGB(255, 55, 63, 81),
  );

  static const _iconColor = Color.fromARGB(255, 55, 63, 81);

  @override
  Widget build(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    final crossAxisCount = width > 600 ? 3 : 2;

    return UniversalScaffold(
      title: "Crazy Cutz",
      body: Padding(
        padding: const EdgeInsets.all(10.0),
        child: GridView.count(
          crossAxisCount: crossAxisCount,
          crossAxisSpacing: 14,
          mainAxisSpacing: 14,
          childAspectRatio: 2.2,
          children: [
            HomeTileButton(
              icon: Icons.login,
              label: "Clock IN",
              onPressed: () {
                ClockDialog.showClocksDialog(
                  context,
                  ClockDialogAction.clockIn,
                );
              },
            ),
            HomeTileButton(
              icon: Icons.logout,
              label: "Clock OUT",
              onPressed: () {
                ClockDialog.showClocksDialog(
                  context,
                  ClockDialogAction.clockOut,
                );
              },
            ),
            HomeTileButton(
              icon: Icons.cut_sharp,
              label: "Transactions",
              onPressed: () {
                Navigator.push(
                  context,
                  MaterialPageRoute(builder: (context) => Transactions()),
                );
              },
            ),
            HomeTileButton(
              icon: Icons.add_box_outlined,
              label: "Add Cuts",
              onPressed: () {
                Navigator.push(
                  context,
                  MaterialPageRoute(builder: (context) => AddCuts()),
                );
              },
            ),
            HomeTileButton(
              icon: Icons.person_add_alt,
              label: "Add Employees",
              onPressed: () {
                Navigator.push(
                  context,
                  MaterialPageRoute(builder: (context) => AddWorker()),
                );
              },
            ),
            HomeTileButton(
              icon: Icons.receipt,
              label: "Reports",
              onPressed: () {
                Navigator.push(
                  context,
                  MaterialPageRoute(builder: (context) => ReportsPage()),
                );
              },
            ),

            // This is your existing "Products" look, now via the same widget:
            HomeTileButton(
              icon: Icons.inventory,
              label: "Products",
              onPressed: () {
                Navigator.push(
                  context,
                  MaterialPageRoute(builder: (context) => AddProducts()),
                );
              },
            ),

            // Sync button: keep special behavior but match styling
            HomeTileButton.custom(
              onPressed: _isSyncing
                  ? null
                  : () async {
                      setState(() => _isSyncing = true);
                      try {
                        await SyncService().syncAll();
                        if (!mounted) return;
                        ScaffoldMessenger.of(context).showSnackBar(
                          const SnackBar(content: Text('Cloud Sync Complete!')),
                        );
                      } catch (e) {
                        if (!mounted) return;
                        ScaffoldMessenger.of(context).showSnackBar(
                          SnackBar(content: Text('Sync Failed: $e')),
                        );
                      } finally {
                        if (mounted) setState(() => _isSyncing = false);
                      }
                    },
              child: Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  _isSyncing
                      ? const SizedBox(
                          width: 20,
                          height: 20,
                          child: CircularProgressIndicator(strokeWidth: 2),
                        )
                      : const Icon(
                          Icons.cloud_upload,
                          color: _iconColor,
                          size: 22,
                        ),
                  const SizedBox(width: 10),
                  Text(
                    _isSyncing ? "Syncing..." : "Sync to Cloud",
                    style: _labelStyle,
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class HomeTileButton extends StatelessWidget {
  final VoidCallback? onPressed;
  final IconData? icon;
  final String? label;
  final Widget? child;

  const HomeTileButton({
    super.key,
    required this.onPressed,
    required this.icon,
    required this.label,
  }) : child = null;

  const HomeTileButton.custom({
    super.key,
    required this.onPressed,
    required this.child,
  }) : icon = null,
       label = null;

  static const _labelStyle = TextStyle(
    fontSize: 18,
    fontWeight: FontWeight.bold,
    fontFamily: "RobotoMono",
    color: Color.fromARGB(255, 55, 63, 81),
  );

  static const _iconColor = Color.fromARGB(255, 55, 63, 81);

  @override
  Widget build(BuildContext context) {
    return SizedBox.expand(
      child: ElevatedButton(
        onPressed: onPressed,
        style: ElevatedButton.styleFrom(
          elevation: 4,
          backgroundColor: Colors.white,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
          padding: const EdgeInsets.symmetric(horizontal: 12),
        ),
        child:
            child ??
            Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(icon!, color: _iconColor, size: 24),
                const SizedBox(width: 12),
                Text(label!, style: _labelStyle),
              ],
            ),
      ),
    );
  }
}
